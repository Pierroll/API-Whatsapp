WhatsApp Bot API (Polka + Baileys)

Bot de WhatsApp minimalista con API REST, hecho con:

Baileys
 para conectarse a WhatsApp

Polka
 como servidor HTTP ligero

Autenticaci√≥n por API Key (endpoints privados) + Login por cookie para ver el QR sin exponerlo p√∫blicamente

PM2 para producci√≥n

‚ö†Ô∏è Aviso: este proyecto usa WhatsApp Web no-oficial (Baileys). √ösalo bajo tu propio criterio y respetando T√©rminos de Uso de WhatsApp.

üì¶ Estructura
API-Whatsapp/
‚îú‚îÄ src/
‚îÇ  ‚îî‚îÄ app.js               # Servidor y l√≥gica del bot
‚îú‚îÄ scripts/
‚îÇ  ‚îî‚îÄ cleanup-session.js   # Limpieza de sesi√≥n/QR/logs
‚îú‚îÄ ecosystem.config.js     # PM2 (producci√≥n)
‚îú‚îÄ package.json
‚îú‚îÄ .env.example
‚îú‚îÄ .gitignore
‚îî‚îÄ README.md

üîß Requisitos

Node.js 18+ (recomendado 20+)

pnpm (o npm/yarn)

corepack enable || npm i -g pnpm

üß™ 1) Instalaci√≥n y uso en local (desarrollo)
1.1 Clonar e instalar
git clone https://github.com/Pierroll/API-Whatsapp.git
cd API-Whatsapp
pnpm install

1.2 Variables de entorno

Usa .env (o define en ecosistema de PM2 m√°s adelante). Copia el ejemplo:

cp .env.example .env


Valores m√≠nimos:

PORT=3000
API_KEY=pon_aqui_tu_api_key_larga

# Login para ver el QR:
QR_LOGIN_USER=admin
QR_LOGIN_PASS=cambialo
COOKIE_SECRET=una_clave_secreta_larga_y_aleatoria


TIP: genera secretos aleatorios:

node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

1.3 Arrancar en dev
pnpm run dev
# => http://localhost:3000

1.4 Flujo para vincular sesi√≥n (QR)

Abre http://localhost:3000/login

Ingresa usuario/clave (QR_LOGIN_USER / QR_LOGIN_PASS)

Redirigir√° a http://localhost:3000/qr-view (muestra el QR y refresca cada 15s)

Escanea con WhatsApp ‚Üí Dispositivos vinculados

Una vez conectado, el bot queda activo. Si ya hay sesi√≥n, /qr-view no deja ver QR (debes cerrar sesi√≥n primero).

1.5 Tests r√°pidos (curl)

Health (p√∫blico)

curl http://localhost:3000/health


Estado (API key)

curl -H "X-API-Key: TU_API_KEY" http://localhost:3000/api/status


Obtener QR (requiere login en navegador)

JSON: http://localhost:3000/api/qr

PNG: http://localhost:3000/api/qr?format=image

Enviar mensaje (API key)

curl -X POST http://localhost:3000/api/send \
  -H "X-API-Key: TU_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"to":"51907690125","message":"Hola!"}'


Historial (API key)

curl -H "X-API-Key: TU_API_KEY" "http://localhost:3000/api/messages?limit=50"


Cerrar sesi√≥n WhatsApp (API key)

curl -X POST http://localhost:3000/api/logout \
  -H "X-API-Key: TU_API_KEY"

üöÄ 2) Producci√≥n con PM2 (VPS)

Ejemplo en Ubuntu 24.04 con Node 20+ y puerto 3002.

2.1 Preparar servidor
# 1) Clonar
git clone https://github.com/Pierroll/API-Whatsapp.git
cd API-Whatsapp

# 2) Instalar dependencias
pnpm install

2.2 Configurar PM2

Edita ecosystem.config.js (incluye tus variables):

module.exports = {
  apps: [
    {
      name: "whatsapp-api",
      script: "src/app.js",
      watch: false,
      env: {
        NODE_ENV: "production",
        PORT: "3002",
        API_KEY: "TU_API_KEY_LARGA",
        QR_LOGIN_USER: "wa-user-api",
        QR_LOGIN_PASS: "cambia-esto",
        COOKIE_SECRET: "clave-super-secreta-y-larga"
      }
    }
  ]
}

2.3 Arrancar con PM2
pm2 start ecosystem.config.js --only whatsapp-api --update-env
pm2 save
pm2 status
pm2 logs whatsapp-api

2.4 Probar en producci√≥n

Health: http://TU_IP:3002/health

Login QR: http://TU_IP:3002/login ‚Üí luego /qr-view

Estado con API key:

curl -H "X-API-Key: TU_API_KEY" http://TU_IP:3002/api/status

2.5 Mantener tras reinicio del VPS
pm2 startup           # sigue las instrucciones
pm2 save

2.6 Actualizar desde Git
cd /ruta/a/API-Whatsapp
git fetch origin
git pull --rebase origin main   # si muestra conflictos, resu√©lvelos o usa merge
pnpm install
pm2 restart whatsapp-api --update-env

üîÅ Flujo de activaci√≥n / restablecimiento

Primera vez:

Abres /login, entras y ves /qr-view.

Escaneas el QR ‚Üí conectado.

Sesi√≥n activa:

/qr-view te indicar√° que ya hay sesi√≥n activa (no muestra QR).

Forzar nuevo QR:

API: POST /api/logout (con API key), o

Borrar sesi√≥n y reiniciar (ver limpieza).

Vincular de nuevo: vuelve al login y repite.

üßπ Limpieza / Restablecimiento
Opci√≥n A) Script incluido
pnpm run cleanup
# borra: ./auth_info_baileys, qr-code.png, *.log
# e intenta matar procesos locales relacionados

Opci√≥n B) Manual
pm2 stop whatsapp-api 2>/dev/null || true
pm2 delete whatsapp-api 2>/dev/null || true
pm2 flush

rm -rf ./auth_info_baileys
rm -f ./qr-code.png
find . -maxdepth 1 -type f -name "*.log" -delete

pm2 start ecosystem.config.js --only whatsapp-api --update-env
pm2 logs whatsapp-api

üîê Autenticaci√≥n y seguridad

API Key (cabecera X-API-Key) para endpoints sensibles: /api/status, /api/send, /api/messages, /api/logout.

Login por cookie para ver el QR: /login ‚Üí /qr-view y /api/qr.

Nunca subas tu .env a Git.
.gitignore ya incluye:

node_modules/
.env
auth_info_baileys/
qr-code.png
*.log


Usa HTTPS en producci√≥n (Nginx reverse proxy recomendado). Si usas HTTPS, a√±ade Secure a la cookie (ver c√≥digo Set-Cookie).

üìö Endpoints (documentaci√≥n)
M√©todo	Ruta	Auth	Descripci√≥n
GET	/health	‚ùå	Estado b√°sico del servicio
GET	/login	‚ùå	Formulario de login para ver el QR
POST	/login	‚ùå	Env√≠a { user, pass } y crea cookie de sesi√≥n
GET	/qr-view	‚úÖ Cookie	Vista HTML con la imagen del QR (auto-refresh)
GET	/api/qr	‚úÖ Cookie	QR en JSON o ?format=image (PNG)
GET	/api/status	‚úÖ API Key	{ status, isConnected, qrAvailable }
POST	/api/send	‚úÖ API Key	Env√≠a un mensaje: { to, message } (usar n√∫mero internacional, sin +)
GET	/api/messages	‚úÖ API Key	√öltimos mensajes recibidos: ?limit=50
POST	/api/logout	‚úÖ API Key	Cierra sesi√≥n de WhatsApp y regenera QR al reiniciar
GET	/logout	‚úÖ Cookie	Cierra la sesi√≥n web (cookie) para el acceso al QR
Ejemplos (producci√≥n puerto 3002)
# Health (p√∫blico)
curl http://TU_IP:3002/health

# Estado (API Key)
curl -H "X-API-Key: TU_API_KEY" http://TU_IP:3002/api/status

# Enviar mensaje (API Key)
curl -X POST http://TU_IP:3002/api/send \
  -H "X-API-Key: TU_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"to":"51907690125","message":"Hola desde VPS!"}'

üõ†Ô∏è Troubleshooting

No veo QR: aseg√∫rate de usar /login ‚Üí /qr-view. Si el estado es connected, primero haz POST /api/logout (API Key).

Puerto en uso:

lsof -nP -iTCP:3002 -sTCP:LISTEN
kill -9 <PID>


Variables de entorno no cargan: revisa pm2 env 0 y reinicia con:

pm2 restart ecosystem.config.js --only whatsapp-api --update-env
pm2 save


Baileys build scripts ignorados por pnpm**:**
Si lo necesitas, permite builds:

pnpm approve-builds
pnpm rebuild

      üß∞ Comandos √∫tiles (chuleta)
      # Dev
      pnpm run dev

      # Limpieza
      pnpm run cleanup

      # PM2
      pm2 start ecosystem.config.js --only whatsapp-api --update-env
      pm2 restart whatsapp-api --update-env
      pm2 stop whatsapp-api && pm2 delete whatsapp-api
      pm2 logs whatsapp-api
      pm2 save
      pm2 startup

      # Git (actualizar servidor)
      git fetch origin
      git pull --rebase origin main
      pnpm install
      pm2 restart whatsapp-api --update-env


¬°Listo! Con esto deber√≠as poder desarrollar, desplegar y operar tu bot sin dolor.